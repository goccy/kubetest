//go:build !ignore_autogenerated
// +build !ignore_autogenerated

package v1

import (
	"context"
	"os"
	"time"

	"k8s.io/client-go/kubernetes"
	"k8s.io/client-go/rest"
)

type RunMode int

const (
	RunModeKubernetes RunMode = iota
	RunModeLocal
	RunModeDryRun
)

type Runner struct {
	cfg       *rest.Config
	clientset *kubernetes.Clientset
	runMode   RunMode
	logger    *Logger
}

func NewRunner(cfg *rest.Config, runMode RunMode) *Runner {
	return &Runner{
		cfg:     cfg,
		runMode: runMode,
	}
}

func (r *Runner) SetLogger(logger *Logger) {
	r.logger = logger
}

func (r *Runner) Run(ctx context.Context, testjob TestJob) (*Result, error) {
	startedAt := time.Now()
	if r.logger == nil {
		r.logger = NewLogger(os.Stdout, LogLevelInfo)
	}
	ctx = WithLogger(ctx, r.logger)
	clientset, err := kubernetes.NewForConfig(r.cfg)
	if err != nil {
		return nil, err
	}
	resourceMgr := NewResourceManager(clientset, testjob)
	if err := resourceMgr.Setup(ctx); err != nil {
		return nil, err
	}
	defer resourceMgr.Cleanup()
	builder := NewTaskBuilder(r.cfg, resourceMgr, testjob.Namespace, r.runMode)
	var result Result
	for _, step := range testjob.Spec.PreSteps {
		task, err := builder.Build(step.Template)
		if err != nil {
			return nil, err
		}
		preStepResult, err := task.Run(ctx)
		if err != nil {
			return nil, err
		}
		result.preStepResults = append(result.preStepResults, preStepResult)
	}
	scheduler := NewTaskScheduler(testjob.Spec.Strategy, builder)
	taskGroup, err := scheduler.Schedule(ctx, testjob.Spec.Template)
	if err != nil {
		return nil, err
	}
	taskResult, err := taskGroup.Run(ctx)
	if err != nil {
		return nil, err
	}
	if err := resourceMgr.ExportArtifacts(); err != nil {
		return nil, err
	}
	result.taskResult = taskResult
	result.StartedAt = startedAt
	result.ElapsedTime = time.Since(startedAt)
	// copy final artifact
	return &result, nil
}

type ResultStatus int

const (
	ResultStatusSuccess ResultStatus = iota
	ResultStatusFailure
)

type Result struct {
	Status         ResultStatus
	StartedAt      time.Time
	ElapsedTime    time.Duration
	preStepResults []*TaskResult
	taskResult     *TaskResultGroup
}
