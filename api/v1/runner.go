//go:build !ignore_autogenerated
// +build !ignore_autogenerated

package v1

import (
	"context"

	"k8s.io/client-go/kubernetes"
	"k8s.io/client-go/rest"
)

type Runner struct {
	cfg       *rest.Config
	clientset *kubernetes.Clientset
}

func (r *Runner) Run(ctx context.Context, testjob TestJob) error {
	resourceMgr := NewResourceManager(r.clientset, testjob)
	defer resourceMgr.Cleanup()
	builder := NewTaskBuilder(r.cfg, resourceMgr, testjob.Namespace)
	for _, step := range testjob.Spec.PreSteps {
		task, err := builder.Build(step.Template)
		if err != nil {
			return err
		}
		if err := task.Run(ctx); err != nil {
			return err
		}
	}
	scheduler := NewTaskScheduler(testjob.Spec.Strategy, builder)
	taskGroup, err := scheduler.Schedule(ctx, testjob.Spec.Template)
	if err != nil {
		return err
	}
	if err := taskGroup.Run(ctx); err != nil {
		return err
	}
	// copy final artifact
	return nil
}
